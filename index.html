<html>

<head>

<style>
	body
	{
		font-family: Helvetica, Arial;
		padding: 0px;
		margin: 0px;
	}
	#canvas:
	{
		margin: 0px;
		padding: 0px;
	}
	span.playerNation
	{
		cursor: pointer;
	}

</style>
	<link href="js/jqueryui/jquery-ui.css" rel="stylesheet">
	<!--//<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>//-->
	<script src="js/chance.min.js"></script>
	<script src="js/jqueryui/external/jquery/jquery.js"></script>
	<script src="js/jqueryui/jquery-ui.js"></script>
	<script src="http://ajax.cdnjs.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
	<!--//<script src="http://backbonejs.org/backbone-min.js"></script>//-->
	<script src="js/backbone-min.js"></script>

	<script>
		// Global Variables

		var tool_tileindex;
		var tool_unitlist;
		var tool_clickmode;
		
		var startGame = false;
		
		var unitRef = [];
		
		var playersMax = 1;
		var playerCurrent = 0;
		
		var unitView;
		var objectView;
		var helpview;
		var unitSelect;
		var cityView;
		var viewList;
		var map;
		var unitdefs;
		var key = [];
		var MapGenerator;
		
		var TILE_UNEXPLORED = 11;
		
		var itemlist;
		
		function nationFactory(name)
		{
			switch(name)
			{
				case 'England':
					return new NationEngland({});
					break;
				case 'Anonymous Tribe':
					return new NationTribe({});
					break;
			}
			return false;
		}
		function buildingFactory(name, city)
		{
			switch(name)
			{
				case 'Factory':
					return new ModelFactory({"city": city});
					break;
				case 'Wealth':
					return new ModelWealth({"city": city});
					break;
				case 'Citizens':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 10});
					break;
				case 'Engineers':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 25});
					break;
				case 'Riflemen':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 100});
					break;
				case 'Mechanized Infantry':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 15000});
					break;
				case 'Tank':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 70000});
					break;
				case 'Artillery':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 25000});
					break;
				case 'Archer':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 15});
					break;
				case 'Spearman':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 15});
					break;
				case 'Spy':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 50});
					break;
				case 'Diplomat':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 50});
					break;
				case 'Gunmen':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 35});
					break;
				case 'Marines':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 100});
					break;
				case 'Cargo Truck':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 50});
					break;
				case 'Supply Caravan':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 25});
					break;
				case 'Guerillas':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 40});
					break;
				case 'Alpine Riflemen':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 50});
					break;
				case 'Labourers':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 25});
					break;
				case 'Battleship':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 500000});
					break;
				case 'Corvette':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 200000});
					break;
				case 'Destroyer':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 500000});
					break;
				case 'Carrier':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 3000000});
					break;
				case 'Cargo Vessel':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 100000});
					break;
				case 'Submarine':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 250000});
					break;
				case 'Bomber':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 200000});
					break;
				case 'Fighter':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 125000});
					break;
				case 'Fighter Jet':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 500000});
					break;
				case 'Bomber Jet':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 600000});
					break;
				case 'Stealth Jet':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 750000});
					break;
				case 'Helicopter':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 300000});
					break;
				case 'Missile':
					return new ModelStructureUnit({"city": city, "name": name, "buildCost": 600000});
					break;
			}
			return false;
		}
		function unitFactory(map, x, y, typeID, ownerID, citizen)
		{	
			if (ownerID == undefined) { ownerID = currentPlayer; }
			var typedef = {};
			switch(typeID)
			{
				case "Citizen":
					typedef = new ModelUnitCitizen({
							"ownerID": ownerID
						});
					break;
				case "Engineer":
					typedef = new ModelUnitEngineer({
							"ownerID": ownerID
						});
					break;
				case "Riflemen":
					typedef = new ModelUnitRiflemen({
							"ownerID": ownerID
						});
					break;
				case "Mechanized Infantry":
					typedef = new ModelUnitMechanizedInfantry({
							"ownerID": ownerID
						});
					break;
				case "Tank":
					typedef = new ModelUnitTank({
							"ownerID": ownerID
						});
					break;
				case "Artillery":
					typedef = new ModelUnitArtillery({
							"ownerID": ownerID
						});
					break;
			}
			if (citizen == undefined)
			{
				var voro = map.mapdata.get(x, y, 0).voronoi;
				var bp = map.mapdata.voronoi[voro].name;
				citizen = new ModelCitizen({birthplace: bp, name: bp, type: typeID});
			}
			if (typedef.newTurn == undefined)
			{
				return false;
			}
			typedef.x = x;
			typedef.y = y;
			typedef.citizen = citizen;
			typedef.newTurn();
			typedef = jQuery.extend(true, {}, typedef);
			map.addUnit(x, y, typedef);
			map.mapdata.exploreTile(x, y, typedef);
			return typedef;
		}

		
		var unitTypes = [
				{ "name": "Aircraft", "consumes": ["aluminium", "oil", "arms"], "description": "Aircraft made out of aluminum, travelling at hundreds of kilometers per hour and loaded with dangerous armament will terrify your enemies." }
				,{ "name": "Infantry", "consumes": ["supplies", "arms"], "description": "" }
				,{ "name": "Mobile Infantry", "consumes": ["supplies", "arms", "oil", "steel", "rubber"], "description": "" }
				,{ "name": "Ship", "consumes": ["supplies", "arms", "oil", "steel"], "description": "" }
				,{ "name": "Tank", "consumes": ["supplies", "arms", "oil", "steel", "rubber"], "description": "" }
				,{ "name": "Missile", "consumes": ["aluminum", "oil", "steel"], "description": "" }
			];
		var unitModels = [
				{ "name": "Fighter", "type": "Aircraft", "cost": 10, "consumption": [
						{"type": "aluminium", "qty": 1 }
						,{"type": "oil", "qty": 1 }
						,{"type": "arms", "qty": 2 }
					]
					,"airAttack": 3
					,"airDefense": 1		
					,"groundAttack": 1
					,"groundDefense": 0
					,"speed": 8
					,"loiter": 2
					,"amphibian": false
					,"engineering": false
					,"airborne": false
					,"seafaring": false
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				 }
				,{ "name": "Bomber", "type": "Aircraft", "cost": 15, "consumption": [
						{"type": "aluminium", "qty": 2 }
						,{"type": "oil", "qty": 2 }
						,{"type": "arms", "qty": 4 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 2
					,"groundDefense": 0
					,"speed": 5
					,"loiter": 4
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": false
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				}

				,{ "name": "Marines", "type": "Infantry", "cost": 5, "consumption": [
						{"type": "supplies", "qty": 1 }
						,{"type": "arms", "qty": 1 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 1
					,"groundDefense": 2
					,"speed": 1
					,"loiter": 0
					,"amphibian": true
					,"airborne": false
					,"engineering": false
					,"seafaring": false
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				}
				,{ "name": "Riflemen", "type": "Infantry", "cost": 5, "consumption": [
						{"type": "supplies", "qty": 1 }
						,{"type": "arms", "qty": 1 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 1
					,"groundDefense": 2
					,"speed": 1
					,"loiter": 0
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": false
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				}
				,{ "name": "Mobile Infantry", "type": "Mobile Infantry", "cost": 8, "consumption": [
						{"type": "supplies", "qty": 2 }
						,{"type": "arms", "qty": 2 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 1
					,"groundDefense": 1
					,"speed": 3
					,"loiter": 4
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": false
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 2
				}
				,{ "name": "Mobile Infantry", "type": "Mobile Infantry", "cost": 8, "consumption": [
						{"type": "supplies", "qty": 2 }
						,{"type": "arms", "qty": 2 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 1
					,"groundDefense": 1
					,"speed": 3
					,"loiter": 4
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": false
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 2
				}
				,{ "name": "Light Tank", "type": "Tank", "cost": 10, "consumption": [
						{"type": "supplies", "qty": 5 }
						,	{"type": "steel", "qty": 3 }
						,{"type": "arms", "qty": 5 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 4
					,"groundDefense": 2
					,"speed": 3
					,"loiter": 4
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": false
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				}
				,{ "name": "Paratrooper", "type": "Infantry", "cost": 7, "consumption": [
						{"type": "supplies", "qty": 1 }
						,{"type": "arms", "qty": 1 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 1
					,"groundDefense": 1
					,"speed": 2
					,"loiter": 0
					,"amphibian": false
					,"airborne": true
					,"engineering": false
					,"seafaring": false
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				}
				,{ "name": "Engineer", "type": "Infantry", "cost": 7, "consumption": [
						{"type": "supplies", "qty": 1 }
						,{"type": "arms", "qty": 1 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 1
					,"groundDefense": 1
					,"speed": 1
					,"loiter": 0
					,"amphibian": false
					,"airborne": false
					,"engineering": true
					,"seafaring": false
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				}

				,{ "name": "Submarine", "type": "Ship", "cost": 15, "consumption": [
						{"type": "supplies", "qty": 5 }
						,{"type": "oil", "qty": 3 }
						,{"type": "steel", "qty": 3 }
						,{"type": "arms", "qty": 2 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 0
					,"groundDefense": 0
					,"seaAttack": 1
					,"seaDefense": 1
					,"subseaAttack": 1
					,"speed": 2
					,"loiter": 6
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": true
					,"submarine": true
					,"airCarry": 0
					,"landCarry": 0
				}
				,{ "name": "Destroyer", "type": "Ship", "cost": 20, "consumption": [
						{"type": "supplies", "qty": 5 }
						,{"type": "oil", "qty": 3 }
						,{"type": "steel", "qty": 3 }
						,{"type": "arms", "qty": 2 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 1
					,"groundDefense": 0
					,"seaAttack": 1
					,"seaDefense": 1
					,"subseaAttack": 1
					,"speed": 2
					,"loiter": 10
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": true
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				}
				,{ "name": "Cruiser", "type": "Ship", "cost": 25, "consumption": [
						{"type": "supplies", "qty": 5 }
						,{"type": "oil", "qty": 4 }
						,{"type": "steel", "qty": 4 }
						,{"type": "arms", "qty": 4 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 2
					,"groundDefense": 0
					,"seaAttack": 2
					,"seaDefense": 1
					,"subseaAttack": 0
					,"speed": 3
					,"loiter": 10
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": true
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				}
				,{ "name": "Battleship", "type": "Ship", "cost": 80, "consumption": [
						{"type": "supplies", "qty": 15 }
						,{"type": "oil", "qty": 10 }
						,{"type": "steel", "qty": 15 }
						,{"type": "arms", "qty": 10 }
					]
					,"airAttack": 1
					,"airDefense": 2
					,"groundAttack": 5
					,"groundDefense": 0
					,"seaAttack": 5
					,"seaDefense": 2
					,"subseaAttack": 0
					,"speed": 2
					,"loiter": 15
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": true
					,"submarine": false
					,"airCarry": 0
					,"landCarry": 0
				}
				,{ "name": "Carrier", "type": "Ship", "cost": 50, "consumption": [
						{"type": "supplies", "qty": 15 }
						,{"type": "oil", "qty": 10 }
						,{"type": "steel", "qty": 10 }
						,{"type": "arms", "qty": 5 }
					]
					,"airAttack": 0
					,"airDefense": 0
					,"groundAttack": 0
					,"groundDefense": 0
					,"seaAttack": 0
					,"seaDefense": 0
					,"subseaAttack": 0
					,"speed": 3
					,"loiter": 15
					,"amphibian": false
					,"airborne": false
					,"engineering": false
					,"seafaring": true
					,"submarine": false
					,"airCarry": 4
					,"landCarry": 0
				}
			];
		
	</script>

	<script src="js/gamelib.js"></script>

	<script>
		var evolveCount = 0;
		function evolveBiomeUI()
		{
			if (evolveCount > 0)
			{
				window.setTimeout(function () {
					map.mapdata.evolveBiomes();
					evolveCount = evolveCount - 1;
					evolveBiomeUI();
				}, 400);
			}
			if (evolveCount < 0)
			{
				evolveCount = 0;
			}
		}
	

		function createSettlement(x, y, unit)
		{
			var unitRange = unit.range;
			var ownerID = unit.ownerID;
			var needles = [];
			var cityRange = 5 		// Minimum number of squares between cities.
			var city = map.mapdata.voronoi[map.mapdata.get(x, y).voronoi].city;	// Get the regions' city, if there isn't one already.
			if (city == undefined)
			{		
				var voronoiID = map.mapdata.get(x, y).voronoi;
				var townname = undefined;
				if (ownerID == 0)
				{
					var culture = new CultureAnglo({});
					culture.generateList();
//console.log(											townname = prompt("Settlement Name", randomName));
					var ni = 0;
					while(townname == undefined)
					{
						randomName = culture.namelist[ni];
						townname = prompt("Settlement Name", randomName);
						ni++;
						if (ni >= culture.namelist.length)
						{
							ni = 0;
						}
					}
				}
				var citizen = [];
				citizen.push(jQuery.extend(true, {}, unit.citizen));
				if (townname == undefined)
				{
					var culture = new CultureAnglo({});
					culture.generateList();
					townname = chance.pick(culture.namelist);
				}
				var cityObj = new ModelSettlement({name: townname, ownerID: unit.ownerID, citizens: citizen, "x": x, "y": y});
				map.settle(x, y, cityObj);
				map.mapdata.setRegionOwner(unit.ownerID, voronoiID);
				map.mapdata.removeUnit(x, y, unit);
			}
			else
			{
				if (ownerID == 0)
				{
					alert("This region already has a settlement. If you already own this region, you can divide it and create a new region which can be settled.");
				}
			}
		}

		// User Interface Views
		var UnitList = Backbone.View.extend({
			el: "#contents"
			,maptile: undefined
			,units: undefined
			,maxWidth: 150
			,width: 150
			,initialize: function (arg)
			{
				if (arg.units != undefined)
				{
					this.units = arg.units;
				}
				else if (arg.maptile != undefined)
				{
					this.maptile = arg.maptile;
				}
			}
			,render: function() {
			}
			,draw: function ()
			{
				var ctx = document.getElementById("contents").getContext("2d");
				var left = 800 - this.width;

				ctx.fillStyle = "rgba(0, 200, 255, 100)";
				ctx.fillRect(left, 50, this.width, 500);
				ctx.font = "14pt Arial";
				ctx.fillStyle = "#000";
				ctx.fillText("Units", left + 10, 70);

				if (this.units.length = 1)
				{
					// Only one unit in the list? Go directly to unit orders view.
					ctx.fillText(this.units[i].name, left + 10, 100 + (i * 15));
				}
			}
		});
		
		var mapGenerateView = Backbone.View.extend({
			el: "#MapSetup"
			,seed: 0
			,initialize: function (arg)
			{
				me = this;
				if (arg.seed != undefined)
				{
					me.seed = arg.seed;
					$("#mapSeed").val(chance.pad(me.seed, 16));
				}
				else
				{
					this.seed = chance.integer({min: 0, max: 9007199254740992});
					$("#mapSeed").val(chance.pad(me.seed, 16))
				}
				$("#mapSeed").change(function (e) {
					this.seed = parseInt($("#mapSeed").val());
					if (me.seed < 0)
					{
						me.seed = parseInt(me.seed) * -1;
					}
					$("#mapSeed").val(chance.pad(me.seed, 16));
				});
				$("#mapWidth").val(map.mapdata.mapwidth);
				$("#mapHeight").val(map.mapdata.mapheight);
				$("#mapMaxRegions").val(map.mapdata.voronoi_max);
				$("#mapMinRegions").val(map.mapdata.voronoi_min);
				$("#mapSeaHeight").val(map.mapdata.sea_height);
				$("#mapMountainHeight").val(map.mapdata.mountain_height);
				$("#mapPlayerMax").val(playersMax);
				
				$("#mapSeedRandomize").click(function () {
					me.seed = chance.integer({min: 0, max: 9007199254740992});64
					$("#mapSeed").val(chance.pad(me.seed, 16));
				});
				
				$("#mapPreview").click(function () {
					map.mapdata.mapwidth = parseInt($("#mapWidth").val());
					map.mapdata.mapheight = parseInt($("#mapHeight").val());
					map.mapdata.voronoi_max = parseInt($("#mapMaxRegions").val());
					map.mapdata.voronoi_min = parseInt($("#mapMinRegions").val());
					map.mapdata.sea_height = $("#mapSeaHeight").val();
					map.mapdata.mountain_height = $("#mapMountainHeight").val();
					playersMax = parseInt($("#mapPlayerMax").val());
					map.mapdata.seed = parseInt(me.seed);			
					map.mapdata.generate();	
					map.mapdata.exploreAll(0);				
				});
				$("#mapContinue").click(function () {
					map.mapdata.obscureAll(0);
					placeStartingUnits();
					startGame = true;
					map.el = "contents";
					map.scalex = 8;
					map.scaley = 8;
					$("#MapSetup").dialog("close");
				});
				$("#mapBiomeEvolve").click(function () {
					evolveCount = parseInt($("#mapBiomeEvolveSteps").val());
					evolveBiomeUI();
				});
				map.mapdata.generate();
				map.mapdata.exploreAll(0);
				
				this.updatePlayerList();


				$(this.el).dialog("option", "minWidth", 600);
				$(this.el).dialog("open");
			}
			,updatePlayerList: function ()
			{
				$("#mapPlayers").unbind().empty();
				var me = this;
				for (var i=0; i < map.nations.length; i++)
				{
					var nation = map.nations[i];
					var p = $("#mapPlayers").append("<li><span class='playerNation'>" + nation.name + "</span></li>");
					var desc = nation.description;
					$(p).unbind().click(function () {
						$("#nationAbout > p").text(desc);
						var canv = $("#nationAbout > p").append("<canvas id='miniflagcanvas' width=96 height=64></canvas>");
						var flagctx = document.getElementById("miniflagcanvas").getContext("2d");
						
						nation.flag.draw(0, 0, 96, flagctx);
						
						

					});
					$(p).find("span.playerNation").click(function () {
						var curName = $(this).text();
						var pn = $(this).unbind().empty().html("<select id='presetNations'></select>");
						me.populatePresetNations(curName);
					})
				}
			}
			,populatePresetNations: function (curName)
			{
				var me = this;
				var nationlist = [
					"England"
					,"France"
					,"Germany"
					,"Italy"
					,"Russia"
					,"Japan"
					,"China"
				];
				for (var i=0; i < nationlist.length; i++)
				{
					var sel = "";
					if (nationlist[i] == curName)
					{
						sel = " selected";
					}
					$("#presetNations").append("<option" + sel + ">" + nationlist[i] + "</option>");
				}
				$("#presetNations").change(function () {
					var newName = $(this).find("option:selected").text();
					var index = $(this).parent().index();
					map.nations[index].name = newName;
					me.updatePlayerList();
				});
			}
			,render: function (arg)
			{

			}
		});
		
		var CityView = Backbone.View.extend({
			el: "#CityView"
			,tiles: []
			,city: undefined
			,left: 200
			,top: 200
			,width: 400
			,height: 250
			,initialize: function(arg)
			{
				this.city = undefined;
				this.tiles = [];
				if (arg.city != undefined)
				{
					this.city = arg.city;
				}
			}			
			,show: function()
			{
				this.updateText();
				$(this.el).dialog({title: this.city.name, autoOpen: true, left: this.left, top: this.top
						,width: 500, height: 500});
			}
			,updateText: function()
			{
				var me = this;	// Scope hack.
			
				$(this.el).find("#cityNameHeader").text(this.city.name);

				$(this.el).find("#cityType").text(this.city.type);

				$(this.el).find("#cityFoodAmt").text(this.city.food);

				$(this.el).find("#cityManufacturing").text(this.city.manufacturing);
				
				if (this.city != undefined)
				{
					if (this.city.production != undefined)
					{
						$(this.el).find	("#cityProduction").text(this.city.production);
					}
				}

				$(this.el).find("#cityMP").text("Producing " + this.city.production + " " + this.city.mp + '/' + this.city.mp_max);
				
				$(this.el).find("#cityOwner").text(this.city.ownerID);
				$(this.el).find("#cityCitizens").empty();
				for (var i=0; i < this.city.citizens.length; i++)
				{
					$(this.el).find("#cityCitizens").append("<li>" + this.city.citizens[i].name + " (" + this.city.citizens[i].type + ")</li>");
				}
				
				$(this.el).find("#cityInventory").empty();
				for (var i in this.city.inventory.items)
				{
					$(this.el).find("#cityInventory").append("<li>" + this.city.inventory.items[i].name + " x" + this.city.inventory.items[i].qty + "</li>");
				}
				
				$(this.el).find("#prodChange").unbind().click(function () {
					me.city.production = $("#cityProduces option:selected").text();
					var structure = buildingFactory(me.city.production, me.city);
					if (!structure)
					{
						alert("Error! '" + me.city.production + " not found in buldingFactory()");
					}
					else
					{
						me.city.mp = 0;
						me.city.mp_max = structure.buildCost;
						me.updateText();
					}
				});
			}
			,render: function()
			{
				this.updateText();
			}
			,hide: function()
			{
				$(this.el).dialog("close");				
			}

		});
		var ObjectView = Backbone.View.extend({
			initialize: function(arg)
			{
				this.el = "#ObjectView";
				this.left = 200;
				this.top = 200;
				this.width = 400;
				this.height = 250;
				this.x = 0;
				this.y = 0;
				this.object = undefined;
				this.tiles = [];
				this.x = 0;
				this.y = 0;
				
				if (arg.object != undefined)
				{
					this.object = arg.object;
				}
				var me = this;
				$(this.el).find("#changeproduction").unbind().click(function () {				
					me.object.produces = $(me.el).find("#objectProduces option").filter(":selected").text();
					me.updateText();
				});
				$(this.el).find("#changeProductionCity").unbind().click(function () {
					var city = $(me.el).find("#productionCityList option").filter(":selected").text();
					
					var cities = map.mapdata.getCity(me.x, me.y, 3); 
					for (var i = 0; i < cities.length; i++)
					{
						if (cities[i].name == city)
						{
							me.object.city = cities[i];
							break;
						}
					}
					me.updateText();
				});
			}			
			,show: function(x, y, arg)
			{
				if (arg != undefined)
				{
					this.object = arg;
				}
				this.x = x;
				this.y = y;
				this.updateText();
				$(this.el).dialog({title: this.object.name, autoOpen: true, left: this.left, top: this.top
						,width: 500, height: 400});
				$(this.el).show();
			}
			,updateText: function()
			{
				map.mapdata.setObject(this.x, this.y, this.object);
				$(this.el).find("#productionCityList").empty();
				var cname = "Nowhere";
				if (this.object.city != undefined
					&& this.object.city.name != undefined)
				{
					cname = this.object.city.name;
				}
				$(this.el).find("#productionCity").text(cname);
				var nearbyCities = map.mapdata.getCity(this.x, this.y, 3);
				for (var c = 0; c < nearbyCities.length; c++)
				{
					if (nearbyCities[c].ownerID == 0)
					{
						$(this.el).find("#productionCityList").append("<option>" + nearbyCities[c].name + "</option>");
					}
				}

				$(this.el).find("#currentProduction").text(this.object.produces);
				$(this.el).find("#objectConsumes").text(this.object.consumes);

				if (this.city != undefined)
				{
					$(this.el).find("#cityNameHeader").text(this.city.name);

					$(this.el).find("#cityType").text(this.city.type);

					$(this.el).find("#cityFoodAmt").text(this.city.food);

					$(this.el).find("#cityOwner").text(this.city.ownerID);
					$(this.el).find("#cityCitizens").empty();
					for (var i=0; i < this.city.citizens.length; i++)
					{
						$(this.el).find("#cityCitizens").append("<li>" + this.city.citizens[i].name + " (" + this.city.citizens[i].type + ")</li>");
					}
				}
			}
			,render: function()
			{
				this.updateText();
			}
			,hide: function()
			{
				$(this.el).dialog("close");				
			}

		});
		var UnitView = Backbone.View.extend({
			el: "#unitOrders"
			,maptile: undefined
			,unit: undefined
			,left: 200
			,initialize: function (arg)
			{
				if (arg.unit != undefined)
				{
					this.unit = arg.unit;
				}
				else if (arg.maptile != undefined)
				{
					this.maptile = arg.maptile;
				}
				else if (arg.unit != undefined)
				{
					this.unit = arg.unit;
				}
				this.updateText();
				this.show();

			}
			,show: function()
			{
				/*$(this.el).css({
					position: 'absolute'
					,padding: 10
					,"background-color": 'rgba(100, 200, 255, 125)'
					,color: '#000'
					,left: 0
					,top: 550
					,width: 300
					,height: 50
				});*/
				$(this.el).dialog({title: this.unit.name, autoOpen: true, left: 825});
			}
			,hide: function()
			{
				$(this.el).dialog("close");
			}
			,render: function()
			{
			}
			,updateText: function()
			{
				if (this.unit == undefined) { return; }
				$(this.el).empty();
				var me = this;
				$(this.el).html("<p style='clear: right'>" + this.unit.name + " Moves: " + this.unit.move_points + " OwnerID: " + this.unit.ownerID + "</p><input type='button' value='North' id='movenorth'><input type='button' value='East' id='moveeast'><input type='button' value='South' id='movesouth'><input type='button' value='West' id='movewest'><input type='button' value='Settle' id='settle'><input type='button' value='Plow' id='plow'><input type='button' value='Build Wall' id='buildWall'><input type='button' id='noOrders' value='No Orders'>");
				
				$(this.el).find("#movenorth").click(function () {
					var x = parseInt(me.unit.x);
					var y = parseInt(me.unit.y);
					me.unit = map.moveUnit(x, y, me.unit, x, y - 1);
					me.unit.spriteset.setAnimation("Unit");
					me.updateText();
				});
				$(this.el).find("#movesouth").click(function () {
					var x = parseInt(me.unit.x);
					var y = parseInt(me.unit.y);
					me.unit = map.moveUnit(x, y, me.unit, x, y + 1);
					me.unit.spriteset.setAnimation("Unit");
					me.updateText();
				});
				$(this.el).find("#moveeast").click(function () {
					var x = parseInt(me.unit.x);
					var y = parseInt(me.unit.y);
					me.unit = map.moveUnit(x, y, me.unit, x + 1, y);
					me.unit.spriteset.setAnimation("Unit");
					me.updateText();
				});
				$(this.el).find("#movewest").click(function () {
					var x = parseInt(me.unit.x);
					var y = parseInt(me.unit.y);
					me.unit = map.moveUnit(x, y, me.unit, x - 1, y);
					me.unit.spriteset.setAnimation("Unit");
					me.updateText();
				});
				$(this.el).find("#noOrders").click(function () {
					me.unit.noOrders();
					me.hide();
				});
				$(this.el).find("#settle").hide();
				$(this.el).find("#plow").hide();
				$(this.el).find("#buildWall").hide();
				if (this.unit.abilities != undefined)
				{
					if (this.unit.abilities.settle)
					{
						$(this.el).find("#settle").show();
						var me = this;
						$(this.el).find("#settle").click(function () {
							createSettlement(me.unit.x, me.unit.y, me.unit);
							me.unit = undefined;
							me.hide();
						});
					}
					if (this.unit.abilities.plow)
					{
						var crops = map.tset.getIndexByName("Crops");
						$(this.el).find("#plow").show();
						var me = this;
						$(this.el).find("#plow").click(function () {
							me.unit.noOrders();
							map.mapdata.set(me.unit.x, me.unit.y, crops, 0);	// Crops
//							map.mapdata.set(me.unit.x, me.unit.y, 29, 2);	// Plantation
							map.mapdata.set(me.unit.x, me.unit.y, 0, 1);	// Clear anything on the second layer (forests, etc).
							map.mapdata.setObject(me.unit.x, me.unit.y, new ModelBuilding({
								name: "Plantation (" + me.unit.x + ", " + me.unit.y + ")"
								,produces: 'Nothing'
								,consumes: 'Nothing'
								,buildCost: 100
							}));
							map.mapdata.removeUnit(me.unit.x, me.unit.y, me.unit);
							me.unit = undefined;
							me.hide();							
						});
					}
					var city = map.mapdata.getCity(this.unit.x, this.unit.y, 3);
					if (city)
					{
						if (this.unit.abilities.buildWall)
						{
							$(this.el).find("#buildWall").show();
							var me = this;
							$(this.el).find("#buildWall").click(function () {
								me.unit.noOrders();
								map.mapdata.set(me.unit.x, me.unit.y, 26, 2);	// Build Wall
								me.hide();							
							});
						}
					}
					else
					{
						$(this.el).find("#buildWall").hide();
					}
				}
				$(this.el).find("p").css({padding: 0, margin: 0});
			}
			,draw: function ()
			{	
				//if (this.unit == undefined) { $(this.el).stop().hide("fast"); return; }
			}
		});
		var HelpView = Backbone.View.extend({
			el: "#Help"
			,name: "Help"
			,initialize: function (arg)
			{
				this.refresh();
			}
			,model: unitTypes
			,updateDescription: function (typeIndex)
			{
				var contents = "";
				var unit = unitTypes[typeIndex];
				contents += "<h1>" + unit.name + "</h1>";
				
				contents += "<ul>";
				
				/*contents += "<li>Ground Attack: " + unit.groundAttack + "</li>";
				contents += "<li>Ground Defense: " + unit.groundDefense + "</li>";
				contents += "<li>Speed: " + unit.speed + "</li>";
				contents += "<li>Loiter: " + unit.loiter + "</li>";
				contents += "<li>Amphibious: " + unit.amphibious + "</li>";
				contents += "<li>Air Attack: " + unit.airAttack + "</li>";
				contents += "<li>Air Defense: " + unit.airDefense + "</li>";
				contents += "<li>Airborne: " + unit.airborne + "</li>";
				contents += "<li>Engineering: " + unit.engineering + "</li>";
				contents += "<li>Seafaring: " + unit.seafaring + "</li>";
				contents += "<li>Submarine: " + unit.submarine + "</li>";
				contents += "<li>Air Carry No.: " + unit.airCarry + "</li>";
				contents += "<li>Land Carry No.: " + unit.landCarry + "</li>";*/
								
				for (var i=0; i < unit.consumes.length; i++)
				{
					contents += "<li>" + unit.consumes[i] + "</li>";
				}

				contents += "</ul>";
				
				contents += "<p>" + unit.description + "</p>";
				
				$("#helpContent").html(contents);
			}
			,refresh: function ()
			{
				var me = this;
				$(this.el).find("ul").empty();
				for (var i=0; i < unitTypes.length; i++)
				{
					var uType = $(this.el).find("ul").append("<li>" + unitTypes[i].name + "</li>");
				}
				$(this.el).find("ul > li").stop().click(function () {
					var unitType = $(this).index();
					me.updateDescription(unitType);
				});
			}
			,show: function ()
			{
				this.refresh();
				$(this.el).dialog({autoOpen: true, left: 10, top: 10
						,width: 500, height: 400});
			}
			,hide: function ()
			{
				$(this.el).close();
			}
		});
		var UnitSelectView = Backbone.View.extend({
			el: "#UnitSelection"
			,maptile: undefined
			,unit: undefined
			,left: 200
			,initialize: function (arg)
			{
				if (arg.unit != undefined)
				{
					this.unit = arg.unit;
				}
				else if (arg.maptile != undefined)
				{
					this.maptile = arg.maptile;
				}
				else if (arg.units != undefined)
				{
					this.units = arg.units;
				}
				this.updateText();
				this.show();

			}
			,show: function()
			{
				$(this.el).dialog({autoOpen: true, left: 5, top: 400});
				$(this.el).find("ul").css({
					padding: 0
					,margins: 0
					,color: '#000'
					,"list-style-type": "none"
					,"cursor": "pointer"
				});
				$(this.el).find("ul > li").hover(
					function () {
						$(this).css("background-color", "#999");
					}
					,function (){
						$(this).css("background-color", "transparent");
					}
				);
			}
			,hide: function()
			{
				$(this.el).dialog("close");
			}
			,render: function()
			{
				this.updateText();
			}
			,updateText: function()
			{
				if (this.units == undefined) { return; }
				var ul = $(this.el).find("ul");
				ul.empty();
				var me = this;
				
				for(var i=0; i < this.units.length; i++)
				{
					var newEl = $("<li>" + this.units[i].name + "</li>");
					var myUnit = me.units[i];
					$(newEl).click(function () {
						me.hide();
						unitView = new UnitView({unit: myUnit});
						unitView.updateText();
						unitView.show();
					});
					ul.append(newEl);
				}
			}
		});
	</script>

	<script>
		$( document ).ajaxError(function( event, jqxhr, settings, thrownError ) {
			console.log(event, jqxhr, settings, thrownError);
		});
		
		function placeStartingUnits()
		{
			var placedCount = 0;
			var placedID = 0;
			for (var i=0; i < map.mapdata.voronoi.length; i++)
			{
				if (map.mapdata.voronoi[i].height < map.mapdata.mountain_height
					&& map.mapdata.voronoi[i].height > map.mapdata.sea_height
				)
				{
					var u = unitFactory(map, map.mapdata.voronoi[i].x, map.mapdata.voronoi[i].y, "Citizen", placedID);
					console.log("unitFactory Created:", map.mapdata.voronoi[i].x, map.mapdata.voronoi[i].y, u);
					if (placedID == playerCurrent && u)
					{
						map.scrollx = map.mapdata.voronoi[i].x;
						map.scrolly = map.mapdata.voronoi[i].y;
						map.scrollMapX(-11);
						map.scrollMapY(-10);
					}
					placedCount++;
					placedID++;
				}
				if (placedCount == playersMax)
				{
					break;
				}
			}
		}
			
		function doNewTurn()
		{
			if (unitView != undefined)
			{
				unitView.hide();
				unitView = undefined;			
			}
			map.newTurn();
			
			if (cityView != undefined)
			{
				cityView.render();
			}
		}

		$(document).ready(function () {

			/*
			var PageRouter = Backbone.Router.extend({
				routes: {
					'': 'tileset'
				}
			});

			window.siteRouter = new PageRouter();			
			window.siteRouter.on("route:tileset", function() {	currentPage = new Tileset(); currentPage.load("images/tileset16.png", true); currentPage.render(); });
			Backbone.history.start({pushState: true});*/

			
			map = new Map({mapdata: new ModelMap(), tileset: new Tileset({tileimage: "images/terrain.png", tiledefs: "tiledefs.json"})});
			placeStartingUnits();

			unitsList = new UnitList({});


			viewList = [];
			
						
			viewList.push(map);		
			
			$("#canvas_mapsetup").click(function (e) {
				var ms = $(this); //$("#MapSetup");
				var x = parseInt(	(e.clientX - ms.offset().left) / map.scalex - 12);
				var y = parseInt(	(e.clientY - ms.offset().top) / map.scaley - 10);
				map.scrollMapXAbs(x);
				map.scrollMapYAbs(y);
			});
			
			$("#mapWidth").change(function (e) {
				map.mapdata.mapwidth = parseInt($("#mapWidth").val());
				map.scalex = parseInt(256 / map.mapdata.mapwidth);
				if (map.scalex < 1)
				{
					map.scalex = 1;
				}
			});
			$("#mapHeight").change(function (e) {
				map.mapdata.mapheight = parseInt($("#mapHeight").val());
				map.scaley = parseInt(256 / map.mapdata.mapheight);
				if (map.scaley < 1)
				{
					map.scaley = 1;
				}
			});
			
			var w = window.setInterval(function () {
				if (startGame)
				{
					for (var i=0; i < viewList.length; i++)
					{
						viewList[i].draw();
					}
					if (key['77'])
					{
						map.drawMini();
					}
					
				}
				else
				{
					var el = map.el;
					map.el = "canvas_mapsetup";
					map.drawMini();
					map.el = "contents";
					map.draw();
					map.el = el;
				}

				// If the user is holding down the directional keys, scroll the map.
				if (key['38'])
				{
					// Up arrow
					map.scrollMapY(-1);
				}
				if (key['40'])
				{
					// Down arrow
					map.scrollMapY(1);
				}
				if (key['37'])
				{
					// Left arrow
					map.scrollMapX(-1);
				}
				if (key['39'])
				{
					// Right arrow
					map.scrollMapX(1);
				}
				
			}, 200);


			$("#mapSetupTabs").tabs();
			$("#MapSetup").dialog({
				autoOpen: false,
				width: 400
			});
			
			MapGenerator = new mapGenerateView({});			

			$("#contents").mousemove(function (e) {
				var tilex = Math.floor(e.clientX / 32) + map.scrollx;
				var tiley = Math.floor(e.clientY / 32) + map.scrolly; 

				if (e.buttons == 1 && tool_tileindex != undefined) {
					map.mapdata.set(tilex, tiley, tool_tileindex, map.tset.getTile(tool_tileindex).layer);
				}
			});
			
			
			$("#contents").mouseup(function (e) {
				var tilex = Math.floor(e.clientX / 32) + map.scrollx;
				var tiley = Math.floor(e.clientY / 32) + map.scrolly; 

				if (unitView != undefined && e.buttons == 1)
				{
					unitView.hide();
					unitView = undefined;
				}				
				if (tool_tileindex == undefined && unitView == undefined && e.buttons == 1) {
					map.tooltip.text = '';
					var tileunits = map.mapdata.getUnits(tilex, tiley);
					var tileobjects = map.mapdata.getObjects(tilex, tiley);
					console.log("Tileunits: ", tilex, tiley, tileunits);
					console.log("Tileobjects: ", tilex, tiley, tileobjects);
					if (tileunits == undefined) { return; }
					if (tileunits.length == 1 && tileunits[0].ownerID == playerCurrent)
					{
						unitView = new UnitView({unit: tileunits[0]});
						unitView.updateText();
						unitView.show();
						return;
					}
					else if (tileunits.length > 1)
					{
						//TODO: For multiple units, same view as above, plus a unitListView to allow selecting units on the same tile.
						unitSelect = new UnitSelectView({units: tileunits });
						unitSelect.updateText();
						unitSelect.show();
						return;
					}

					var cityObj = map.mapdata.getCity(tilex, tiley, 0);
					if (cityObj != undefined && cityObj != false)
					{
						cityView = new CityView({city: cityObj});
						cityView.show();
					}

					var object = map.mapdata.getObjects(tilex, tiley);
					if (object != undefined && object != false)
					{
						if (objectView != undefined)
						{
							objectView.remove();
							objectView = undefined;
						}
						objectView = new ObjectView({'object': object});
						objectView.show(tilex, tiley, object);
					}
				}
			});

			$(document).on("contextmenu", "#contents", function (e) {
				var tilex = Math.floor(e.clientX / 32) + map.scrollx;
				var tiley = Math.floor(e.clientY / 32) + map.scrolly; 

				var tile0 = map.mapdata.get(tilex, tiley, 0);
				var tile1 = map.mapdata.get(tilex, tiley, 1);
				var tile2 = map.mapdata.get(tilex, tiley, 2);

				var message;
				if (tile2.tileid > 0)
				{
					message = "Tile ID " + tile2.tileid;
				}
				else if (tile1.tileid > 0)
				{
					message = "Tile ID " + tile1.tileid;
				}
				else
				{	
					message = "Tile ID " + tile0.tileid;
				}
				if (map.tooltip.text.length > 0
					&& map.tooltip.x == tilex && map.tooltip.y == tiley)
				{
					message = '';
				}
				map.tooltip = {x: tilex, y: tiley, text: message};
				
				return false; 
			});

			$("#mapFlagDesign").click( function () {
				$("#FlagDesign").dialog({autoOpen: true, left: 5, top: 5
										,width: 600, height: 500});
			});


			function checkKeys()
			{
				return;
			}
			function checkKeysDown()
			{
				return;
			}

			$( document ).keyup(function( event, jqxhr, settings, thrownError ) {
				checkKeys();
				key[event.keyCode] = false;
			});
			$( document ).keydown(function( event, jqxhr, settings, thrownError ) {
				key[event.keyCode] = true;
				checkKeysDown();
			});

			helpview = new HelpView({});

		});
</script>
</head>

<body>

<canvas id="contents" width="800px" height="640px" style="z-index: 0"></canvas>
<a id="tooltip" title="Test" style="position: absolute"></a>

<!--// <input type='button' value='Clear Tile' onclick="tool_tileindex = undefined; $('#tiles > li').css('color', '#000');"> //-->
<input type='button' value='New Turn' onclick="doNewTurn();">
<input type='button' value='Help' onclick="helpview.show();">
<input type='button' value="Flag Designer" id='mapFlagDesign'>
<div id="tiles" width="800px">
	
</div>

<div id="kb" style="display: none;" width="800px">
	<div id="tiledefs" style="display: none;"></div>
</div>

<div id="unitOrders"></div>

</body>

<div id="CityView" height="400px" width="500px" style="display: none;">

	<p>
		<h2 id='cityNameHeader'>City Name</h2>
		<p>
			Production: <span id='cityProduction'></span> <input type='button' id = "prodChange" value='Change'>
			<br><span><select id='cityProduces'>
						<option class="wealth">Wealth</option>
						
						<option class="building factory">Factory</option>
						<option class="building armaments">Armaments Factory</option>
						<option class="building vehicle">Vehicle Factory</option>
						<option class="building airplane">Airplane Factory</option>
						<option class="building research">Research Lab</option>

						<option class="building coalpower">Coal Plant</option>
						<option class="building hydro">Hydroelectric Plant</option>
						<option class="building gas">Gas Powered Plant</option>
						<option class="building nuclear">Nuclear Plant</option>
					
						<option class="unit infantry">Riflemen</option>
						<option class="unit infantry">Machinegunners</option>
						<option class="unit infantry">Mechanized Infantry</option>

						<option class="unit armour">Tank</option>

						<option class="unit artillery">Artillery</option>

						<option class="unit airplane fighter">Fighter</option>
						<option class="unit airplane bomber">Bomber</option>

						<option class="unit naval destroyer">Destroyer</option>
						<option class="unit naval cruiser">Cruiser</option>
						<option class="unit naval battleship">Battleship</option>
						<option class="unit naval submarine">Submarine</option>
						<option class="unit naval transport">Transport</option>
						
						<option class="unit civilian Citizen">Citizen</option>
						<option class="unit civilian engineer">Engineer</option>
					</select>
				</span>
			<br/>

		</p>
		
		<p>
			Manufacturing: <span id='cityManufacturing'></span>
		</p>

		<p>
			Owner: <span id='cityMP'></span>
		</p>

		<p>
			Owner: <span id='cityOwner'></span>
		</p>
		
		<p>
			<b><span id='cityType'></span></b> <br/>
			Food: <span id='cityFoodAmt'></span> / 10 <br/>
			
		</p>
		
		<p>
			Citizens:
			<ul id='cityCitizens'>
				
			</ul>
		</p>

		<p>
			Inventory:
			<ul id='cityInventory'>
				
			</ul>
		</p>
		
	</p>

</div>

<div id="ObjectView" height="400px" width="500px" style="display: none;">

	<p>
		
		<p>
			<b><span id='objectType'></span></b> <br/>
			Produces: <span id='currentProduction'></span>
			<br><span id='productionControls'><select id='objectProduces'>
						<option>Grain Farms</option>
						<option>Cotton Plantation</option>
						<option>Rubber Plantation</option>
						<option>Paper Mill</option>
						<option>Research Facility</option>
						<option>Coal Mine</option>
						<option>Metals Mine</option>
						<option>Oil Derrick</option>
					</select> <input type='button' id='changeProduction' value='Change'/> <span id='changecost'>(cost to change)</span>
				</span>
			<br/>
			Send Production to: <span id='productionCity'>Nowhere</span>
			<br><span id='productionTarget'><select id='productionCityList'>
				</select> <input type='button' id='changeProductionCity' value='Change'/>
			</span>
			Consumes: <span id='objectConsumption'>Nothing</span> <br/>
			
		</p>
	
	</p>

</div>

<div id="MapSetup" height='250px' title="Game Setup" style="display: none;">
	<canvas id='canvas_mapsetup' width='270px' height='270px' style="margin: 20px"></canvas>

	<div id="mapSetupTabs">
		<ul>
			<li><a href="#tabs-1">Map Settings</a></li>
			<li><a href="#tabs-2">Player Settings</a></li>
			<li><a href="#tabs-3">Tools</a></li>
		</ul>
		<div id="tabs-1">
			<p>
				Seed: <input type='text' id='mapSeed' style="width: 175px;"> <input type='button' id='mapSeedRandomize' value='#'> <br/>
				Width: <input type='text' id='mapWidth' style="width: 50px;"> <br/>
				Height: <input type='text' id='mapHeight' style="width: 50px;"> <br/>
				Region Minimum: <input type='text' id='mapMinRegions' style="width: 50px;"> <br/>
				Region Maximum: <input type='text' id='mapMaxRegions' style="width: 50px;"> <br/>
				<hr/>
				Sea Height: <input type='text' width='20px' id='mapSeaHeight' style="width: 50px;"> <br/>
				Mountain Height: <input type='text' width='20px' id='mapMountainHeight' style="width: 50px;"> <br/>
			</p>
		</div>
		<div id="tabs-2">
			<div id='nationAbout' style="float: right; width: 300px; padding: 0px; margin-top: 0px;">
				<p style="width: 100px: padding: 0px; margin: 5px; overflow-y: scroll; height: 200px;">
				</p>
			</div>

			<div style="width: 200px;">
				Max Number of Players: <input type='text' id='mapPlayerMax' style="width: 50px;"> 
				<script type='text/javascript'>
					function increasePlayers()
					{
						var pcount = parseInt($("#mapPlayerMax").val());
						pcount++;
						playersMax = pcount;
						$("#mapPlayerMax").val(pcount);
						map.nations.push(new NationTribe({}));
						MapGenerator.updatePlayerList();
					}
					
					function decreasePlayers()
					{
						var pcount = parseInt($("#mapPlayerMax").val());
						pcount--;
						if (pcount < 0)
						{
							pcount = 0;
						}
						playersMax = pcount;
						$("#mapPlayerMax").val(pcount);
					}
				</script>
					<input type='button' value='-' onclick='decreasePlayers();'> <input type='button' value='+' onclick='increasePlayers();'> <br/>
				
				<div>
					<div id='mapPlayers' style="width:180px; height:150px; overflow-y: scroll;">
							
					</div>
				</div>
			</div>
		</div>
		<div id="tabs-3">
			<p>
				<input type='button' value="Evolve Biomes" id='mapBiomeEvolve'> <input type='text' value='1' id='mapBiomeEvolveSteps'> steps.
			</p>
		</div>
	</div>	
	<p>
		<input type='button' id='mapPreview' value='Generate'> <input id='mapContinue' type='button' value="Continue">
	</p>
</div>


<div id="UnitSelection" height="250px" width="125px" title="Select Unit" style="display: none">

	<ul style="width: 100%; height: 100%; padding: 0px; margin: 0px">
	
		
		
	</ul>

</div>



	<p>
	</p>

</div>

<div id="Help" title="Help" style="display: none">
	
	<ul style="width: 150px; padding: 0px; margin: 0px; height 100%; border-style: solid; border-width: 1px; list-style-type: none; cursor: pointer; float: left;">
	</ul>
	
	<p id='helpContent' style="widh: 600px">
	</p>
	
</div>

<div id="FlagDesign" title="Flag Design" style="display: none">
	
	<canvas width='200' height='120'>
		
	</p>
	
</div>

</html>
